# üîß Render Deployment Troubleshooting Guide

## Error: "Bad Gateway - Service Unavailable"

This error means your application container is starting but Render can't connect to it. Here's how to fix it:

---

## ‚úÖ Step-by-Step Fix

### 1. Check Environment Variables in Render Dashboard

Go to your Render service ‚Üí **Environment** tab and ensure these are set:

```bash
# Required - AfricasTalking Credentials
AT_USERNAME=Kwepo
AT_API_KEY=atsk_6e210a59fcded0df8da23bd3a3ee9f2cfca0d2ec7d560a07a368438b4e403bb673fac5a4
AT_SHORTCODE=20384
AT_SENDER_ID=20880

# Required - Conductor Credentials
CONDUCTOR_USERNAME=admin
CONDUCTOR_PASSWORD=admin123

# Auto-generated by Render
SECRET_KEY=<auto-generated>
DATABASE_URL=<auto-generated from PostgreSQL>

# Flask Settings
FLASK_ENV=production
DEBUG=False
PYTHONUNBUFFERED=1
```

### 2. Verify Database Connection

**Important:** Your local `.env` has:
```
DATABASE_URL=postgresql://nazigi_user:nazigi2025@localhost:5432/nazigi_sms
```

But on Render, the `DATABASE_URL` should be automatically set to your Render PostgreSQL instance. 

**Check:**
- Go to Render Dashboard ‚Üí Your PostgreSQL database
- Copy the **Internal Database URL**
- Verify it's automatically injected into your web service

### 3. Check Render Logs

```bash
# In Render Dashboard, go to your web service ‚Üí Logs tab
# Look for these errors:

‚ùå "Connection refused" ‚Üí Database not connected
‚ùå "Module not found" ‚Üí Missing dependency
‚ùå "Address already in use" ‚Üí Port conflict (shouldn't happen on Render)
‚ùå "Bind failed" ‚Üí App not listening on $PORT
```

### 4. Common Issues & Fixes

#### Issue A: Health Check Failing
The Dockerfile has a health check that might fail if dependencies aren't installed:

```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:${PORT:-5000}/')" || exit 1
```

**Fix:** Make sure `requests` is in `requirements.txt` (it should be already).

#### Issue B: Port Binding
Render sets the `$PORT` environment variable dynamically. The Dockerfile CMD should be:

```dockerfile
CMD gunicorn --bind 0.0.0.0:${PORT:-5000} wsgi:app
```

This is already correct in your Dockerfile ‚úÖ

#### Issue C: Database Migration Not Run
The app might crash if database tables don't exist.

**Fix:** Add a startup script to run migrations:

Create `start.sh`:
```bash
#!/bin/bash
flask db upgrade
gunicorn --bind 0.0.0.0:${PORT:-5000} \
         --workers 4 \
         --threads 2 \
         --timeout 120 \
         --access-logfile - \
         --error-logfile - \
         --log-level info \
         wsgi:app
```

Then update Dockerfile CMD:
```dockerfile
CMD ["bash", "start.sh"]
```

#### Issue D: AfricasTalking Credentials Invalid
If AT credentials are wrong, the app might crash on startup.

**Fix:** Temporarily comment out SMS initialization in `app.py`:

```python
# Initialize SMS service
# with app.app_context():
#     sms_service.initialize(
#         app.config['AT_USERNAME'],
#         app.config['AT_API_KEY'],
#         app.config.get('AT_SENDER_ID')
#     )
```

This lets you test if the app starts without SMS service.

---

## üîç Debugging Steps

### Step 1: Check Render Logs
```
1. Go to Render Dashboard
2. Select your web service
3. Click "Logs" tab
4. Look for startup errors
```

### Step 2: Test Database Connection
In Render Shell (if available):
```bash
python -c "from app import create_app; app = create_app(); print('App created!')"
```

### Step 3: Check Health Endpoint
Once deployed, test the health check:
```bash
curl https://your-app.onrender.com/
```

Should return:
```html
<!DOCTYPE html>
<html>
<head>
    <title>Nazigi Stamford Bus SMS Service</title>
...
```

---

## üöÄ Quick Fix: Simplified Deployment

If you're still having issues, try this minimal approach:

### 1. Remove Health Check from Dockerfile
Comment out the HEALTHCHECK line temporarily:

```dockerfile
# HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
#     CMD python -c "import requests; requests.get('http://localhost:${PORT:-5000}/')" || exit 1
```

### 2. Use Simpler Gunicorn Command
Update Dockerfile CMD:

```dockerfile
CMD gunicorn --bind 0.0.0.0:$PORT --workers 2 --timeout 120 wsgi:app
```

### 3. Add Startup Script
Create `start.sh`:

```bash
#!/bin/bash
set -e

echo "Starting Nazigi Stamford Bus SMS Service..."

# Run database migrations
echo "Running database migrations..."
flask db upgrade || echo "Warning: Migration failed"

# Start Gunicorn
echo "Starting Gunicorn on port $PORT..."
exec gunicorn \
    --bind 0.0.0.0:$PORT \
    --workers 2 \
    --timeout 120 \
    --access-logfile - \
    --error-logfile - \
    --log-level info \
    wsgi:app
```

Make it executable:
```bash
chmod +x start.sh
```

Update Dockerfile:
```dockerfile
CMD ["./start.sh"]
```

---

## üìä Expected Render Logs (Success)

When everything works, you should see:

```
[INFO] Starting gunicorn 21.2.0
[INFO] Listening at: http://0.0.0.0:10000 (1)
[INFO] Using worker: sync
[INFO] Booting worker with pid: 7
[INFO] Booting worker with pid: 8
```

---

## üÜò Still Not Working?

### Check These:

1. **Build Logs** - Did the Docker build succeed?
   - Look for `Successfully built` message
   - Check for dependency installation errors

2. **Environment Variables** - Are they all set correctly?
   - Especially `DATABASE_URL`
   - All AfricasTalking credentials

3. **Database** - Is PostgreSQL running?
   - Check Render PostgreSQL logs
   - Verify database name matches

4. **Health Check Path** - In `render.yaml`:
   ```yaml
   healthCheckPath: /
   ```
   Make sure your app responds to `GET /` with 200 OK

---

## üéØ Most Likely Issue

**The DATABASE_URL mismatch:**
- Your `.env` file has localhost URL
- Render needs the actual PostgreSQL URL
- This should be auto-injected by Render
- Verify in Render Dashboard ‚Üí Environment tab

**Solution:**
Don't commit `.env` to git. Let Render manage all environment variables through its dashboard.

---

## üìù Next Steps

1. Check Render logs for specific error
2. Verify all environment variables are set
3. Test database connection
4. Simplify deployment (remove health check temporarily)
5. Add startup script with migrations
6. Re-deploy

---

## üí° Pro Tip

Add this to your app for better debugging on Render:

```python
import logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def create_app(config_class=Config):
    app = Flask(__name__)
    logger.info("üöÄ Starting Nazigi Stamford Bus SMS Service...")
    logger.info(f"üìä Database: {app.config['SQLALCHEMY_DATABASE_URI'][:30]}...")
    logger.info(f"üîë AT Username: {app.config['AT_USERNAME']}")
    # ... rest of your code
```

This will show up in Render logs and help you debug!
