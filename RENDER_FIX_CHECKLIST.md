# ğŸš€ Render Deployment Checklist - Quick Fix Guide

## Current Issue: Bad Gateway Error

### âœ… Immediate Actions to Fix Deployment

---

## 1ï¸âƒ£ Verify Environment Variables in Render Dashboard

**Go to:** Render Dashboard â†’ Your Web Service â†’ Environment Tab

**Required Variables:**
```bash
# AfricasTalking API (CRITICAL)
AT_USERNAME=Kwepo
AT_API_KEY=atsk_6e210a59fcded0df8da23bd3a3ee9f2cfca0d2ec7d560a07a368438b4e403bb673fac5a4
AT_SHORTCODE=20384
AT_SENDER_ID=20880

# Conductor Authentication
CONDUCTOR_USERNAME=admin
CONDUCTOR_PASSWORD=admin123

# Flask Configuration
FLASK_ENV=production
DEBUG=False
PYTHONUNBUFFERED=1

# Auto-generated by Render (DO NOT SET MANUALLY)
DATABASE_URL=<automatically set by Render>
SECRET_KEY=<automatically generated>
```

âš ï¸ **IMPORTANT:** 
- Click "Add Environment Variable" for each missing variable
- Do NOT manually set `DATABASE_URL` - it's auto-generated from your PostgreSQL service
- After adding variables, **Deploy Latest Commit** to restart

---

## 2ï¸âƒ£ Check Database Connection

### Verify PostgreSQL Service:
1. Go to Render Dashboard â†’ Databases
2. Find your PostgreSQL database (`nazigi-postgres`)
3. Check status - should show **"Available"**
4. Copy **Internal Database URL**

### Link Database to Web Service:
1. Go to your Web Service â†’ Environment
2. Verify `DATABASE_URL` exists and points to your Render PostgreSQL
3. Format should be: `postgresql://user:pass@hostname:port/dbname`

---

## 3ï¸âƒ£ Check Build Logs

**Go to:** Render Dashboard â†’ Your Web Service â†’ Events Tab â†’ Click latest deploy

### Look For:
âœ… **Success:**
```
==> Building...
Successfully built <image-id>
==> Deploying...
==> Your service is live ğŸ‰
```

âŒ **Failure:**
```
Error: Command failed
Error: Build failed
```

If build failed, check:
- All dependencies in `requirements.txt`
- Dockerfile syntax errors
- Python version compatibility

---

## 4ï¸âƒ£ Check Runtime Logs

**Go to:** Render Dashboard â†’ Your Web Service â†’ Logs Tab

### Expected Output (Success):
```
ğŸš€ Starting Nazigi Stamford Bus SMS Service...
ğŸ“Š Database: postgresql://...
ğŸ”‘ AT Username: Kwepo
ğŸ“¦ Initializing database...
âœ… Database initialized
ğŸ“± Initializing SMS service...
âœ… SMS service initialized
ğŸ”Œ Registering blueprints...
âœ… Blueprints registered
ğŸ‰ Application successfully created!
ğŸš€ Starting Gunicorn server on port 10000
[INFO] Listening at: http://0.0.0.0:10000 (1)
[INFO] Using worker: sync
[INFO] Booting worker with pid: 7
```

### Common Errors:

âŒ **"Connection refused"**
```
sqlalchemy.exc.OperationalError: could not connect to server
```
**Fix:** Database not ready or DATABASE_URL wrong

âŒ **"Module not found"**
```
ModuleNotFoundError: No module named 'xyz'
```
**Fix:** Add missing dependency to `requirements.txt`

âŒ **"Address already in use"**
```
OSError: [Errno 98] Address already in use
```
**Fix:** Port binding issue - shouldn't happen on Render

âŒ **"AT API Error"**
```
âŒ SMS service initialization failed: ...
```
**Fix:** Check AfricasTalking credentials (API key, username)

---

## 5ï¸âƒ£ Test Deployment

### Test Health Endpoint:
```bash
curl https://your-app-name.onrender.com/
```

**Expected Response:**
```html
<!DOCTYPE html>
<html>
<head>
    <title>Nazigi Stamford Bus SMS Service</title>
    ...
```

### Test Dashboard:
```bash
# Should redirect to login
curl https://your-app-name.onrender.com/conductor/dashboard
```

---

## ğŸ”§ Quick Fixes if Still Failing

### Fix 1: Disable Health Check Temporarily
The Dockerfile health check is already commented out. âœ…

### Fix 2: Simplify Workers
If app is slow to start, reduce Gunicorn workers.

Edit `start.sh`:
```bash
--workers 2  # instead of 4
```

### Fix 3: Skip SMS Initialization
If AfricasTalking is causing crashes, the app now logs errors and continues. âœ…

### Fix 4: Manual Database Setup
If migrations fail, create tables manually:

In Render Shell (if available):
```bash
python -c "from app import create_app; from models import db; app = create_app(); app.app_context().push(); db.create_all()"
```

---

## ğŸ“‹ Deployment Steps (Step-by-Step)

### Step 1: Update Code
```bash
# In your local machine
cd /home/subchief/Nazigi
git add .
git commit -m "fix: Update Dockerfile with startup script and better logging"
git push origin main
```

### Step 2: Trigger Deploy in Render
```
1. Go to Render Dashboard
2. Click your web service
3. Click "Manual Deploy" â†’ "Deploy latest commit"
4. Wait for build and deploy (3-5 minutes)
```

### Step 3: Monitor Logs
```
1. While deploying, open Logs tab
2. Watch for errors
3. Look for "ğŸ‰ Application successfully created!"
4. Look for "Listening at: http://0.0.0.0:10000"
```

### Step 4: Test
```bash
# Replace with your actual URL
curl https://nazigi-stamford-sms.onrender.com/
```

---

## ğŸ†˜ Emergency Rollback

If new deployment breaks everything:

**Go to:** Render Dashboard â†’ Your Service â†’ Events Tab

Click "Rollback" on a previous successful deployment.

---

## ğŸ“ Final Checklist Before Contacting Support

- [  ] All environment variables set in Render Dashboard
- [  ] PostgreSQL service is "Available"
- [  ] DATABASE_URL is automatically set
- [  ] AfricasTalking credentials are correct
- [  ] Latest code is pushed to GitHub
- [  ] Build logs show successful build
- [  ] Runtime logs show specific error
- [  ] Health endpoint responds (/)
- [  ] No missing dependencies

---

## ğŸ¯ Most Likely Root Cause

Based on "Bad Gateway" error, the issue is usually:

1. **DATABASE_URL not set** (most common)
   - Solution: Verify in Environment tab
   - Must be automatically injected from PostgreSQL service

2. **App crashes on startup**
   - Solution: Check runtime logs for Python errors
   - Common: ImportError, OperationalError, AttributeError

3. **Port binding issue**
   - Solution: Ensure app binds to `$PORT` environment variable
   - Your Dockerfile already does this âœ…

4. **Missing environment variables**
   - Solution: Add all required vars in Environment tab
   - Especially AT_USERNAME, AT_API_KEY

---

## ğŸ” Debug Command

Add this to your `app.py` for maximum debugging:

```python
import os
import sys

print("="*50)
print("ENVIRONMENT CHECK")
print("="*50)
print(f"Python version: {sys.version}")
print(f"PORT: {os.getenv('PORT', 'NOT SET')}")
print(f"DATABASE_URL: {os.getenv('DATABASE_URL', 'NOT SET')[:50]}...")
print(f"AT_USERNAME: {os.getenv('AT_USERNAME', 'NOT SET')}")
print(f"FLASK_ENV: {os.getenv('FLASK_ENV', 'NOT SET')}")
print("="*50)
```

This is already added via logging! âœ…

---

## ğŸ“Š Success Indicators

### Build Phase:
```
âœ… Successfully built image
âœ… Pushing image to registry
âœ… Image pushed successfully
```

### Deploy Phase:
```
âœ… Starting service with new image
âœ… Health check passed
âœ… Service is live
```

### Runtime Logs:
```
âœ… ğŸš€ Starting Nazigi Stamford Bus SMS Service...
âœ… ğŸ“Š Database: postgresql://...
âœ… âœ… Database initialized
âœ… âœ… SMS service initialized
âœ… ğŸ‰ Application successfully created!
âœ… [INFO] Listening at: http://0.0.0.0:10000
```

---

## ğŸ‰ After Successful Deployment

1. **Test the landing page:**
   ```
   https://your-app.onrender.com/
   ```

2. **Test conductor dashboard:**
   ```
   https://your-app.onrender.com/conductor/dashboard
   ```
   - Login with: admin / admin123

3. **Test SMS callback (update AfricasTalking):**
   ```
   Callback URL: https://your-app.onrender.com/sms/callback
   ```

4. **Test responsive design:**
   - Open dashboard on mobile device
   - Verify all breakpoints work
   - Check touch interactions

---

## ğŸ’¡ Pro Tips

- Render free tier sleeps after 15 min inactivity
- First request after sleep takes ~30 seconds to wake up
- Use Render's "Suspend" instead of "Delete" for testing
- Check Render Status page: status.render.com
- Join Render community forum for help

---

**Next Step:** Push these changes and monitor Render logs! ğŸš€
